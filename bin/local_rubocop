#!/bin/bash

# awkコマンドは遅いかも: https://teramako.hatenadiary.org/entry/20070606/p1

LOCAL_RUBY_VERSION=$(ruby -v 2>&1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
LOCAL_BUNDLER_VERSION=$(bundler -v | awk '{print $3}')

CONTAINER_RUBY_VERSION=$(cat .ruby-version | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
CONTAINER_BUNDLER_VERSION=$(tail -n1 "./Gemfile.lock" | awk '{print $1}')

# rbenvがない場合はhomebrewでインストール
if [ ! -d "${HOME}/.rbenv" ]; then
  brew install rbenv
fi

# rubyのバージョンが異なる場合はrbenvでinstallする
if [ $LOCAL_RUBY_VERSION != $CONTAINER_RUBY_VERSION ]; then
  rbenv install $CONTAINER_RUBY_VERSION
fi

# bundlerのバージョンが異なる場合はgemをインストールする
if [ $LOCAL_BUNDLER_VERSION != $CONTAINER_BUNDLER_VERSION ]; then
  gem install bundler -v $CONTAINER_BUNDLER_VERSION
fi

bundle install
bundle exec rubocop -a --force-exclusion
